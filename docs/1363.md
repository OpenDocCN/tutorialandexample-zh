# MongoDB 中的事务

> 原文：<https://www.tutorialandexample.com/transaction-in-mongodb>

该交易被定义为 MongoDB 的财产，以完全或完全不运营。

事务的作用是告诉 MongoDB 所有的操作要么一起成功，要么一起失败。如果失败，则将数据库回滚到以前的稳定状态。

在 MongoDB 4.0 版本中添加的事务需要一个副本集，即没有 web 服务器或云服务器，事务是不可能的。

## 没有交易？

上图包含带有用户名和 objectID 的“user”集合。

然后是另一个“post”集合，其中有些文档是用户在用户集合中发布的。

在这种情况下，我们希望删除用户和与该用户相似的帖子，但是我们希望确保这两种类型的数据要么被完全删除，要么不被删除。

*   为了实现这种情况，我们可以首先从用户集合中删除用户。
*   存储该用户的 objectID。
*   使用该用户的 objectID，并删除帖子集合中与该 objectID 相似的帖子。

现在，上面提到的步骤将起作用。但这里的问题是，由于一些原因(服务器关闭，网络故障等。)，我们无法使用用户的对象删除帖子，因为该对象已经被删除。

这可能会导致数据库出现问题，因此上面提到的自动删除数据的步骤并不安全。这就是事务的作用出现的地方。

## 有了交易

它告诉 MongoDB 所有的操作要么一起成功，要么一起失败。如果可以运行，数据库必须恢复到以前的稳定状态。

## 交易是如何运作的？

对于该事务，需要一个会话。

会话是指我们对服务器的请求的逻辑分组。会话对象总是必需的，因为我们发送的每个命令都要发送到服务器，而服务器会忘记用户。因此，我们需要一个始终可以被服务器识别的会话。

```
const session = db.getMongo().startSession()
```

这样，就创建了一个会话对象，通过启动事务，可以用它来对请求进行分组。

```
session.startTransaction()
```

上面的命令是用来启动事务的。

> **注意**:如上所述，如果您想使用 MongoDB 中的事务功能，在对数据库进行任何更改之前，必须运行该命令。如果事务没有启动，您的所有更改将直接反映在数据库中。

这个会话对象用于访问集合

```
const usercoll = session.geodatabase("<name_of_database>").userconst postcoll = session.geodatabase("<name_of_database>").post
```

这里，使用会话访问数据库中的两个集合。现在，可以使用这些常量或指针对集合执行所有操作。

如果使用“用户调用”删除用户，它将被删除，但更改不会立即反映在服务器中。

如果我们使用 find()进行搜索，用户将出现在数据库中。要在数据库中反映这些更改，您可以提交事务，或者如果您想关闭会话，也可以中止它。

```
session.commit transaction ()
OR
session.abort transaction () 
```

> **注意**:中止会话的命令不能在提交命令后写入。